using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Windows.Forms;

namespace DataVisualizerApp
{
    public partial class MainForm : Form
    {
        private Dictionary<string, Dictionary<string, string>> tableData = new();
        private Dictionary<string, string> processMap = new();
        private HashSet<string> dataNumbers = new();

        public MainForm()
        {
            InitializeComponent();
        }

        private void btnLoad_Click(object sender, EventArgs e)
        {
            string filterProcess = txtProcess.Text.Trim();
            if (string.IsNullOrEmpty(filterProcess))
            {
                MessageBox.Show("処理名を入力してください。");
                return;
            }

            OpenFileDialog ofd = new OpenFileDialog();
            ofd.Filter = "Text Files|*.txt";
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                LoadAndFilterFile(ofd.FileName, filterProcess);
                DisplayTable();
            }
        }

        private void LoadAndFilterFile(string filePath, string targetProcess)
        {
            tableData.Clear();
            processMap.Clear();
            dataNumbers.Clear();

            foreach (var line in File.ReadLines(filePath))
            {
                var firstSplit = line.Split(new[] { ' ' }, 3, StringSplitOptions.RemoveEmptyEntries);
                if (firstSplit.Length < 2) continue;

                string time = firstSplit[0];
                string process = firstSplit[1];
                string rest = firstSplit.Length >= 3 ? firstSplit[2] : "";

                // 時刻に対応するデータ構造を初期化
                if (!tableData.ContainsKey(time))
                    tableData[time] = new Dictionary<string, string>();

                // 時刻ごとの処理を記録（処理A or 処理Bなど）
                processMap[time] = process;

                // 処理A以外はデータ番号が無いのでスキップ
                if (process != targetProcess) continue;

                // 処理Aのデータを分解
                var fields = rest.Split(',');
                if (fields.Length < 4) continue;

                string dataNo = fields[0];
                string name = fields[2];
                string place = fields[3];

                // データ番号と「名前(場所)」を保持
                tableData[time][dataNo] = $"{name}({place})";
                dataNumbers.Add(dataNo);
            }
        }

        private void DisplayTable()
        {
            dataGridView.Rows.Clear();
            dataGridView.Columns.Clear();

            // 時刻でソート
            var sortedTimes = tableData.Keys
                .Union(processMap.Keys) // 処理Bのみの時刻も含める
                .Distinct()
                .OrderBy(t => t)
                .ToList();

            var sortedDataNos = dataNumbers.OrderBy(p => p).ToList();

            // 列ヘッダー
            dataGridView.Columns.Add("Time", "時刻");
            dataGridView.Columns.Add("Process", "処理");
            foreach (var dataNo in sortedDataNos)
            {
                dataGridView.Columns.Add(dataNo, dataNo);
            }

            // 行データ
            foreach (var time in sortedTimes)
            {
                // 時刻列
                var row = new List<string> { time };

                // 処理列
                processMap.TryGetValue(time, out string process);
                row.Add(process ?? "");

                // データ番号列
                foreach (var dataNo in sortedDataNos)
                {
                    tableData.TryGetValue(time, out var dataMap);
                    string value = dataMap != null && dataMap.TryGetValue(dataNo, out var v) ? v : "";
                    row.Add(value);
                }

                dataGridView.Rows.Add(row.ToArray());
            }
        }
    }
}
---

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Windows.Forms;

namespace DataVisualizerApp
{
    public partial class MainForm : Form
    {
        private Dictionary<string, Dictionary<string, string>> tableData = new();
        private Dictionary<string, string> processMap = new();
        private Dictionary<string, string> nameMap = new();
        private HashSet<string> dataNumbers = new();
        private HashSet<string> allProcesses = new();
        private HashSet<string> allNames = new();

        public MainForm()
        {
            InitializeComponent();
        }

        private void btnLoad_Click(object sender, EventArgs e)
        {
            OpenFileDialog ofd = new OpenFileDialog();
            ofd.Filter = "Text Files|*.txt";
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                LoadFile(ofd.FileName);
                PopulateFilters();
                DisplayTable();
            }
        }

        private void LoadFile(string filePath)
        {
            tableData.Clear();
            processMap.Clear();
            nameMap.Clear();
            dataNumbers.Clear();
            allProcesses.Clear();
            allNames.Clear();

            foreach (var line in File.ReadLines(filePath))
            {
                var firstSplit = line.Split(new[] { ' ' }, 3, StringSplitOptions.RemoveEmptyEntries);
                if (firstSplit.Length < 2) continue;

                string time = firstSplit[0];
                string process = firstSplit[1];
                string rest = firstSplit.Length >= 3 ? firstSplit[2] : "";

                // データ行を初期化
                if (!tableData.ContainsKey(time))
                    tableData[time] = new Dictionary<string, string>();

                // 処理名を保持
                processMap[time] = process;
                allProcesses.Add(process);

                // 処理Aなど詳細データがある場合
                if (!string.IsNullOrWhiteSpace(rest))
                {
                    var fields = rest.Split(',');
                    if (fields.Length >= 4)
                    {
                        string dataNo = fields[0];
                        string name = fields[2];
                        string place = fields[3];
                        string namePlace = $"{name}({place})";

                        tableData[time][dataNo] = namePlace;
                        nameMap[time] = name;
                        allNames.Add(name);
                        dataNumbers.Add(dataNo);
                    }
                }
            }
        }

        private void PopulateFilters()
        {
            // 処理フィルター
            cmbProcessFilter.Items.Clear();
            cmbProcessFilter.Items.Add("すべて");
            foreach (var process in allProcesses.OrderBy(p => p))
            {
                cmbProcessFilter.Items.Add(process);
            }
            cmbProcessFilter.SelectedIndex = 0;

            // 名前フィルター
            cmbNameFilter.Items.Clear();
            cmbNameFilter.Items.Add("すべて");
            foreach (var name in allNames.OrderBy(n => n))
            {
                cmbNameFilter.Items.Add(name);
            }
            cmbNameFilter.SelectedIndex = 0;
        }

        private void btnApplyFilter_Click(object sender, EventArgs e)
        {
            DisplayTable();
        }

        private void DisplayTable()
        {
            dataGridView.Rows.Clear();
            dataGridView.Columns.Clear();

            string selectedProcess = cmbProcessFilter.SelectedItem?.ToString();
            string selectedName = cmbNameFilter.SelectedItem?.ToString();

            var sortedTimes = tableData.Keys
                .Union(processMap.Keys)
                .Distinct()
                .OrderBy(t => t)
                .ToList();

            var sortedDataNos = dataNumbers.OrderBy(p => p).ToList();

            // ヘッダー作成
            dataGridView.Columns.Add("Time", "時刻");
            dataGridView.Columns.Add("Process", "処理");
            foreach (var dataNo in sortedDataNos)
            {
                dataGridView.Columns.Add(dataNo, dataNo);
            }

            // 行を追加
            foreach (var time in sortedTimes)
            {
                processMap.TryGetValue(time, out string process);
                nameMap.TryGetValue(time, out string name);

                // フィルター処理
                if (selectedProcess != "すべて" && process != selectedProcess)
                    continue;
                if (selectedName != "すべて" && name != selectedName)
                    continue;

                var row = new List<string> { time, process };

                foreach (var dataNo in sortedDataNos)
                {
                    tableData.TryGetValue(time, out var dataMap);
                    string value = dataMap != null && dataMap.TryGetValue(dataNo, out var v) ? v : "";
                    row.Add(value);
                }

                dataGridView.Rows.Add(row.ToArray());
            }
        }
    }
}
